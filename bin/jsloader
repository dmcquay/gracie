#!/usr/bin/env node

var DEFAULT_PORT = '7763',
    JSLoader = require('js-loader').JSLoader,
    argv = require('optimist').argv;

if (argv.help) {
    usage();
}

if (argv._.length === 0) {
    usage("must provide at least one source direcotry");
}

var host = argv.host || argv.h,
    port = process.port || argv.p || DEFAULT_PORT,
    jsloader = new JSLoader(argv._);

try {
    var http = require('http');
    http.createServer(function (req, res) {
        JSLoader.handleRequest(req, res, jsloader);
    }).listen(port, host);
    console.log('Server running at http://' + (host ? host : '*') + ':' + port + '/');
} catch (err) {
    usage(err);
}

function usage(errMsg) {
    if (errMsg) {
        console.log("ERROR: " + errMsg);
        console.log();
    }
    console.log("Usage: jsloader [options] SRC_DIR [SRC_DIR...]");
    console.log();
    console.log("Options:");
    console.log("\t--port | -p\tWhat port to bind to. Defaults to " + DEFAULT_PORT + ".");
    console.log("\t--host | -h\tLimit to connections to this host if specified.");
    console.log("\t--help\t\tShow this message.");
    process.exit();
}
